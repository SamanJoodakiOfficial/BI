<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <%- include("../../partials/head") %>

  <body class="bg-primaryBackground">
    <div class="flex flex-col lg:flex-row min-h-screen">
      <!-- Sidebar -->
      <%- include('../../partials/sidebar.ejs') %>

      <!-- Main Content -->
      <main class="flex-1 p-4 lg:p-6">
        <header class="w-full flex flex-col">
          <h2 class="font-bold text-202020 text-lg lg:text-xl">
            داشبورد هوش تجاری
          </h2>

          <div
            class="w-full grid items-center grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"
          >
            <div
              class="w-full min-h-[200px] relative bg-white border rounded-lg mt-8 p-4 border-CBCBCB overflow-auto flex flex-col gap-2 items-center justify-center"
            >
              <div
                class="w-10 h-10 bg-primary ring-8 text-white rounded-xl flex items-center justify-center"
              >
                <i class="ri-group-line"></i>
              </div>
              <div class="flex flex-col gap-1 items-center">
                <span>تعداد کاربران</span>
                <p class="text-404040 text-bold text-1xl">
                  <%= statistics.users || 'داده‌ای یافت نشد' %>
                </p>
              </div>
            </div>

            <div
              class="w-full min-h-[200px] relative bg-white border rounded-lg mt-8 p-4 border-CBCBCB overflow-auto flex flex-col gap-2 items-center justify-center"
            >
              <div
                class="w-10 h-10 bg-primary ring-8 text-white rounded-xl flex items-center justify-center"
              >
                <i class="ri-group-2-line"></i>
              </div>
              <div class="flex flex-col gap-1 items-center">
                <span>تعداد گروه‌ها</span>
                <p class="text-404040 text-bold text-1xl">
                  <%= statistics.groups || 'داده‌ای یافت نشد' %>
                </p>
              </div>
            </div>

            <div
              class="w-full min-h-[200px] relative bg-white border rounded-lg mt-8 p-4 border-CBCBCB overflow-auto flex flex-col gap-2 items-center justify-center"
            >
              <div
                class="w-10 h-10 bg-primary ring-8 text-white rounded-xl flex items-center justify-center"
              >
                <i class="ri-user-community-line"></i>
              </div>
              <div class="flex flex-col gap-1 items-center">
                <span>تعداد زیرگروه‌ها</span>
                <p class="text-404040 text-bold text-1xl">
                  <%= statistics.subGroups || 'داده‌ای یافت نشد' %>
                </p>
              </div>
            </div>

            <div
              class="w-full min-h-[200px] relative bg-white border rounded-lg mt-8 p-4 border-CBCBCB overflow-auto flex flex-col gap-2 items-center justify-center"
            >
              <div
                class="w-10 h-10 bg-primary ring-8 text-white rounded-xl flex items-center justify-center"
              >
                <i class="ri-database-line"></i>
              </div>
              <div class="flex flex-col gap-1 items-center">
                <span>تعداد سوالات</span>
                <p class="text-404040 text-bold text-1xl">
                  <%= statistics.questions || 'داده‌ای یافت نشد' %>
                </p>
              </div>
            </div>

            <div
              class="w-full min-h-[200px] relative bg-white border rounded-lg mt-8 p-4 border-CBCBCB overflow-auto flex flex-col gap-2 items-center justify-center"
            >
              <div
                class="w-10 h-10 bg-primary ring-8 text-white rounded-xl flex items-center justify-center"
              >
                <i class="ri-chat-1-line"></i>
              </div>
              <div class="flex flex-col gap-1 items-center">
                <span>تعداد پاسخ‌ها</span>
                <p class="text-404040 text-bold text-1xl">
                  <%= statistics.responses || 'داده‌ای یافت نشد' %>
                </p>
              </div>
            </div>
          </div>
        </header>

        <!-- Errors -->
        <% var errors = errors || '' %> <% if (errors.length >= 1) { %> <%
        errors.forEach((error) => { %>
        <div
          class="w-full min-h-8 rounded-lg mt-4 bg-error-light-1 text-error text-sm flex items-center p-4 gap-1"
        >
          <i class="ri-error-warning-line"></i>
          <%= error.msg %>
        </div>
        <% }) %> <% } %>
        <!-- Error -->
        <% if (errorMessage && errorMessage.length > 0) { %>
        <div
          class="w-full min-h-8 rounded-lg mt-4 bg-error-light-1 text-error text-sm flex items-center p-4 gap-1"
        >
          <i class="ri-error-warning-line"></i>
          <%= errorMessage %>
        </div>
        <% } %>

        <!--Success-->
        <% if (successMessage && successMessage.length > 0) { %>
        <div
          class="w-full min-h-8 rounded-lg mt-4 bg-success-light-1 text-white text-sm flex items-center p-4 gap-1"
        >
          <i class="ri-error-warning-line"></i>
          <%= successMessage %>
        </div>
        <% } %>

        <!-- BI Details -->
        <div class="w-full grid items-center grid-cols-1 gap-4">
          <div
            class="w-full min-h-[200px] relative flex flex-col justify-center bg-white border rounded-lg mt-8 p-4 border-CBCBCB overflow-auto"
          >
            <h2 class="text-primary text-2xl text-bold">نمایش جدول</h2>
            <table
              class="w-full bg-white border mt-8 p-4 overflow-auto border-CBCBCB border-collapse text-sm --odd:bg-white even:bg-slate-100 [&:nth-child(odd)]:bg-gray-400"
            >
              <thead>
                <tr class="bg-primary text-white text-center font-bold">
                  <th class="px-3 py-4 text-center">نام گروه</th>
                  <th class="px-3 py-4 text-center">نام زیرگروه</th>
                  <th class="px-3 py-4 text-center">تعداد سوالات</th>
                  <th class="px-3 py-4 text-center">تعداد جواب (بله)</th>
                  <th class="px-3 py-4 text-center">تعداد جواب (خیر)</th>
                  <th class="px-3 py-4 text-center">میانگین جواب‌های (بله)</th>
                </tr>
              </thead>
              <tbody>
                <% if (report && report.length > 0) { report.forEach((item) => {
                %>
                <tr class="border-b-2 border-b-ADADAD">
                  <td class="px-3 py-4 text-center">
                    <%= item._id.groupName || 'داده‌ای یافت نشد' %>
                  </td>
                  <td class="px-3 py-4 text-center">
                    <%= item._id.subGroupName || 'داده‌ای یافت نشد' %>
                  </td>
                  <td class="px-3 py-4 text-center">
                    <%= item.totalQuestions || 'داده‌ای یافت نشد' %>
                  </td>
                  <td class="px-3 py-4 text-center">
                    <%= item.totalYes || 'داده‌ای یافت نشد' %>
                  </td>
                  <td class="px-3 py-4 text-center">
                    <%= item.totalNo || 'داده‌ای یافت نشد' %>
                  </td>
                  <td class="px-3 py-4 text-center">
                    <%= item.avgYesScore || 'داده‌ای یافت نشد' %>
                  </td>
                </tr>

                <% }) } else { %>
                <p class="text-lg mt-4 text-primary">
                  <%= 'داده‌ای یافت نشد'%>
                </p>
                <% } %>
              </tbody>
            </table>
          </div>

          <div
            class="w-full min-h-[200px] relative flex flex-col gap-4 justify-center bg-white border rounded-lg mt-8 p-4 border-CBCBCB overflow-auto"
          >
            <% if (report && report.length > 0) { %>
            <h2 class="text-primary text-2xl text-bold">نمایش نمودار</h2>
            <ul class="mt-4 flex flex-col gap-4">
              <% report.forEach(item => { %>
              <h3 class="text-202020">
                گروه: <%= item._id.groupName || 'داده‌ای یافت نشد' %>
              </h3>
              <div class="bg-slate-300 text-202020 rounded-xl p-4 marker:hidden">
                <h3 class="text-202020">
                  زیرگروه: <%= item._id.subGroupName || 'داده‌ای یافت نشد' %>
                </h3>
                <ul class="mt-6 bg-slate-400 p-2 rounded-xl">
                  <li class="flex gap-1 items-center">
                    <i class="ri-information-line text-primary"></i>تعداد بله:
                    <span class="text-404040">
                      <%= item.totalYes || '0' %> بله
                    </span>
                  </li>
                  <li class="flex gap-1 items-center">
                    <i class="ri-information-line text-primary"></i> تعداد خیر:
                    <span class="text-404040">
                      <%= item.totalNo || '0' %> خیر
                    </span>
                  </li>
                  <li class="flex gap-1 items-center">
                    <i class="ri-information-line text-primary"></i>میانگین خیر:
                    <span class="text-404040">
                      <%= item.totalNo === 0 ? '0' : item.avgNoScore || '0' %>
                      میانگین
                    </span>
                  </li>
                  <li class="flex gap-1 items-center">
                    <i class="ri-information-line text-primary"></i>میانگین بله
                    :
                    <span class="text-404040">
                      <%= item.avgYesScore || '0' %> میانگین
                    </span>
                  </li>
                </ul>

                <div
                  class="chart-container grid sm:w-full md:grid-cols-2 items-center bg-slate-200 rounded-xl mt-4"
                >
                  <div class="chart-box">
                    <canvas
                      id="chartYes-<%= item._id.subGroupName.replace(/ /g, '') %>"
                      width="200"
                      height="100"
                    ></canvas>
                  </div>

                  <div class="chart-box">
                    <canvas
                      id="chartPie-<%= item._id.subGroupName.replace(/ /g, '') %>"
                      width="200"
                      height="100"
                    ></canvas>
                  </div>

                  <div class="chart-box">
                    <canvas
                      id="chartLine-<%= item._id.subGroupName.replace(/ /g, '') %>"
                      width="200"
                      height="100"
                    ></canvas>
                  </div>

                  <div class="chart-box">
                    <canvas
                      id="chartStacked-<%= item._id.subGroupName.replace(/ /g, '') %>"
                      width="200"
                      height="100"
                    ></canvas>
                  </div>
                </div>

                <script>
                  const yesData_<%= item._id.subGroupName.replace(/ /g, '') %> = <%= JSON.stringify(item.totalYes || 0) %>;
                  const noData_<%= item._id.subGroupName.replace(/ /g, '') %> = <%= JSON.stringify(item.totalNo || 0) %>;
                  const avgYesData_<%= item._id.subGroupName.replace(/ /g, '') %> = <%= JSON.stringify(item.avgYesScore || 0) %>;
                  const avgNoData_<%= item._id.subGroupName.replace(/ /g, '') %> = <%= JSON.stringify(item.avgNoScore || 0) %>;

                  const ctxYes_<%= item._id.subGroupName.replace(/ /g, '') %> = document.getElementById('chartYes-<%= item._id.subGroupName.replace(/ /g, '') %>').getContext('2d');
                  new Chart(ctxYes_<%= item._id.subGroupName.replace(/ /g, '') %>, {
                    type: 'bar',
                    data: {
                      labels: ['بله'],
                      datasets: [{
                        label: 'تعداد بله',
                        data: [yesData_<%= item._id.subGroupName.replace(/ /g, '') %>],
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                      }]
                    },
                    options: {
                      scales: {
                        y: { beginAtZero: true }
                      }
                    }
                  });

                  const ctxPie_<%= item._id.subGroupName.replace(/ /g, '') %> = document.getElementById('chartPie-<%= item._id.subGroupName.replace(/ /g, '') %>').getContext('2d');
                  new Chart(ctxPie_<%= item._id.subGroupName.replace(/ /g, '') %>, {
                    type: 'pie',
                    data: {
                      labels: ['بله', 'خیر'],
                      datasets: [{
                        label: 'نسبت بله و خیر',
                        data: [yesData_<%= item._id.subGroupName.replace(/ /g, '') %>, noData_<%= item._id.subGroupName.replace(/ /g, '') %>],
                        backgroundColor: ['rgba(75, 192, 192, 0.2)', 'rgba(255, 99, 132, 0.2)'],
                        borderColor: ['rgba(75, 192, 192, 1)', 'rgba(255, 99, 132, 1)'],
                        borderWidth: 1
                      }]
                    },
                    options: {
                      responsive: true
                    }
                  });

                  const ctxLine_<%= item._id.subGroupName.replace(/ /g, '') %> = document.getElementById('chartLine-<%= item._id.subGroupName.replace(/ /g, '') %>').getContext('2d');
                  new Chart(ctxLine_<%= item._id.subGroupName.replace(/ /g, '') %>, {
                    type: 'line',
                    data: {
                      labels: ['میانگین'],
                      datasets: [
                        {
                          label: 'میانگین بله',
                          data: [avgYesData_<%= item._id.subGroupName.replace(/ /g, '') %>],
                          fill: false,
                          borderColor: 'rgba(75, 192, 192, 1)',
                          tension: 0.1
                        },
                        {
                          label: 'میانگین خیر',
                          data: [avgNoData_<%= item._id.subGroupName.replace(/ /g, '') %>],
                          fill: false,
                          borderColor: 'rgba(255, 99, 132, 1)',
                          tension: 0.1
                        }
                      ]
                    },
                    options: {
                      responsive: true
                    }
                  });

                  const ctxStacked_<%= item._id.subGroupName.replace(/ /g, '') %> = document.getElementById('chartStacked-<%= item._id.subGroupName.replace(/ /g, '') %>').getContext('2d');
                  new Chart(ctxStacked_<%= item._id.subGroupName.replace(/ /g, '') %>, {
                    type: 'bar',
                    data: {
                      labels: ['بله/خیر'],
                      datasets: [
                        {
                          label: 'بله',
                          data: [yesData_<%= item._id.subGroupName.replace(/ /g, '') %>],
                          backgroundColor: 'rgba(75, 192, 192, 0.2)',
                          borderColor: 'rgba(75, 192, 192, 1)',
                          borderWidth: 1,
                          stack: 'stack1'
                        },
                        {
                          label: 'خیر',
                          data: [noData_<%= item._id.subGroupName.replace(/ /g, '') %>],
                          backgroundColor: 'rgba(255, 99, 132, 0.2)',
                          borderColor: 'rgba(255, 99, 132, 1)',
                          borderWidth: 1,
                          stack: 'stack1'
                        }
                      ]
                    },
                    options: {
                      scales: {
                        x: {
                          stacked: true
                        },
                        y: {
                          stacked: true
                        }
                      }
                    }
                  });
                </script>
              </div>
            </ul>
            <% }) } else { %>
            <p class="text-lg mt-4 text-primary"><%= 'داده‌ای یافت نشد'%></p>
            <% } %>
          </div>
        </div>
      </main>
    </div>
  </body>
</html>
